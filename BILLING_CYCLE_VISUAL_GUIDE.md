# ğŸ“… BILLING CYCLE VISUAL EXPLANATION

## Your Question:
> "If user buys plan at 15th March and uses all scans in March,  
> will the scans limit reset on 1st April?"

---

## âš ï¸ ANSWER: **NO - Resets on 15th April**

---

## ğŸ“Š Visual Timeline

```
MARCH 2025                          APRIL 2025
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1  2  3  4  5  6  7  8  9  10   â”‚  1  2  3  4  5  6  7  8  9  10   â”‚
â”‚ 11 12 13 14 [15]16 17 18 19 20   â”‚ 11 12 13 14 [15]16 17 18 19 20   â”‚
â”‚ 21 22 23 24 25 26 27 28 29 30 31 â”‚ 21 22 23 24 25 26 27 28 29 30    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â–²                                  â–²
            March 15                            April 15
         ğŸ‰ PURCHASED                        âœ… RESETS HERE
         500 pages                          (not April 1st!)
```

---

## ğŸ“– Story of User "John"

### âœ… Correct Understanding:

```
ğŸ“… March 15, 2025 - 10:00 AM
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ John buys Pro Plan                  â”‚
â”‚ â€¢ 500 pages/month                   â”‚
â”‚ â€¢ billing_period_start: March 15    â”‚
â”‚ â€¢ pages_used: 0                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“… March 20, 2025 - 3:00 PM
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ John uploads 100 invoices           â”‚
â”‚ â€¢ 500 pages total                   â”‚
â”‚ â€¢ pages_used: 500 âŒ ALL USED       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“… April 1, 2025 - 9:00 AM
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ John tries to upload                â”‚
â”‚ âŒ BLOCKED!                          â”‚
â”‚ Reason: Only 17 days passed         â”‚
â”‚ (Need 1 full month = 30+ days)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“… April 10, 2025 - 2:00 PM
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ John tries again                    â”‚
â”‚ âŒ STILL BLOCKED!                    â”‚
â”‚ Reason: Only 26 days passed         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“… April 15, 2025 - 10:01 AM
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ John uploads new invoice            â”‚
â”‚ âœ… SUCCESS!                          â”‚
â”‚ â€¢ 1 month passed âœ…                  â”‚
â”‚ â€¢ pages_used: 0 (reset)             â”‚
â”‚ â€¢ billing_period_start: April 15    â”‚
â”‚ â€¢ New 500-page quota unlocked       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âŒ Common Misconception

### What People Think:

```
âŒ WRONG ASSUMPTION:
"Billing resets on 1st of every month"

March:  Purchase on 15th â†’ Use 500 pages
April:  Reset on 1st â†’ Get 500 new pages âŒ

This is NOT how it works!
```

### How It Actually Works:

```
âœ… CORRECT LOGIC:
"Billing resets on PURCHASE ANNIVERSARY"

March:  Purchase on 15th â†’ Use 500 pages
April:  Reset on 15th â†’ Get 500 new pages âœ…

Each cycle is EXACTLY 1 month from purchase date!
```

---

## ğŸ” Why Anniversary-Based?

### Reason 1: **Fairness**
```
Calendar Reset:
- Buy March 31 â†’ Only 1 day until April 1 reset âŒ

Anniversary Reset:
- Buy March 31 â†’ Full 30 days until March 31 reset âœ…
```

### Reason 2: **Load Distribution**
```
Calendar Reset:
- Everyone resets April 1 â†’ Server overload âŒ

Anniversary Reset:
- Users reset on different days â†’ Even load âœ…
```

### Reason 3: **Simplicity**
```
Calendar Reset:
- Track: Purchase date, current month, last reset month
- Complex edge cases (month lengths, leap years)

Anniversary Reset:
- Track: Just billing_period_start
- Simple: months_passed >= 1? Reset!
```

---

## ğŸ§® Math Behind Reset

### SQL Logic:
```sql
-- How many months between two dates?
months_passed = EXTRACT(YEAR FROM AGE(now, start)) * 12 +
                EXTRACT(MONTH FROM AGE(now, start))

-- Examples:
March 15 â†’ April 1:  AGE = 17 days  = 0 months  âŒ No reset
March 15 â†’ April 14: AGE = 30 days  = 0 months  âŒ No reset
March 15 â†’ April 15: AGE = 1 month  = 1 month   âœ… RESET!
March 15 â†’ April 16: AGE = 32 days  = 1 month   âœ… RESET!
```

### Real Test Cases:

| Purchase Date | Current Date | Months | Reset? |
|---------------|--------------|--------|--------|
| Jan 31 | Feb 28 | 0 | âŒ |
| Jan 31 | Mar 1 | 1 | âœ… |
| Feb 28 | Mar 28 | 1 | âœ… |
| Feb 28 | Mar 27 | 0 | âŒ |
| Dec 15 | Jan 15 | 1 | âœ… |
| Dec 31 | Jan 1 | 0 | âŒ |

---

## ğŸ¯ Key Takeaways

### 1ï¸âƒ£ Reset is ANNIVERSARY-BASED
- Not calendar month (1st of month)
- Exactly 1 month from purchase date
- Example: March 15 â†’ April 15

### 2ï¸âƒ£ Reset is AUTOMATIC
- Checks on every upload
- No manual action needed
- Happens instantly when month passes

### 3ï¸âƒ£ Reset is FAIR
- Full 30-day cycle for everyone
- No matter when you buy in month
- Pro-rated? No - full quota each cycle

### 4ï¸âƒ£ Unused Quota DOESN'T CARRY OVER
- Use 100/500 pages in March
- April 15: Reset to 0/500 (not 400/500)
- Start fresh each cycle

---

## ğŸ’¡ Pro Tips for Users

### Tip 1: Plan Your Usage
```
Buy on 15th of month
â†’ Heavy usage near month-end (30th-31st) is safe
â†’ Still have 15 days until reset
```

### Tip 2: Check Quota Before Large Batch
```
âœ… Always check pages_remaining before upload
âœ… System shows: "250/500 pages used"
âœ… Plan large batches around reset date
```

### Tip 3: Understand "Month"
```
1 month = Calendar month difference, not 30 days

Jan 31 â†’ Feb 28 = 1 month (28 days) âœ…
Feb 1 â†’ Feb 28 = 0 months (27 days) âŒ
Feb 28 â†’ Mar 28 = 1 month (28 days) âœ…
```

---

## ğŸ”§ Technical Implementation

### Where Reset Happens:
```typescript
// In upload/page.tsx (line ~142)
await supabase.rpc('check_and_reset_billing_period', {
  user_id_param: user.id
})

// SQL checks:
if (months_passed >= 1) {
  UPDATE users SET
    pages_used_this_month = 0,
    billing_period_start = NOW()  â† New cycle starts
  WHERE id = user_id;
}
```

### When It's Called:
- âœ… Every file upload (before quota check)
- âœ… Automatic, no cron job needed
- âœ… Instant reset when eligible

---

## ğŸ“ User Support Scenarios

### Scenario 1: "Why can't I upload? It's April!"
**Answer:** Your billing cycle started March 15, so it resets April 15 (not April 1).

### Scenario 2: "I bought on March 31, only got 1 day?"
**Answer:** No - you get a full month. Reset is March 31 â†’ April 30 (1 full month).

### Scenario 3: "Can I reset early by upgrading?"
**Answer:** Upgrading changes your limit but keeps your billing_period_start. Wait for anniversary.

### Scenario 4: "I have 100 pages left, can they carry over?"
**Answer:** No - quota resets to full amount (500) on your anniversary, unused pages don't carry over.

---

## âœ… FINAL ANSWER

### Question: 
> "User buys plan at 15th March and uses all scans in March,  
> will the scans limit reset on 1st April?"

### Answer:
# âŒ NO

### Correct Reset Date:
# âœ… April 15th
(Exactly 1 month after purchase)

---

**System:** Anniversary-based billing  
**Logic:** months_passed >= 1  
**Reset:** Automatic on first upload after 1 month  
**Fair:** Everyone gets full cycle regardless of purchase date  

ğŸ‰ **This is the better design!** ğŸ‰
